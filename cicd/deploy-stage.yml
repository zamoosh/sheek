deploy_stage:
  stage: deploy
  variables:
    IMAGE_ID: "website:"
  only:
    refs:
      - stage
    changes:
      - cicd/version.txt
  environment:
    name: $PROJECT_NAME
  dependencies:
    - build_all
  script:
    - pwd
    - export VERSION=$(cat cicd/version.txt)
    - docker build . -t $IMAGE_ID$VERSION
    - docker-compose --env-file ./config/.env.stage config
    - docker-compose -p domainerstage up -d
    - rsync -avz static/ /var/www/html/static/
